<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guardian Connect â€” Web</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#0F172A;
      --panel:#1E293B;
      --muted:#94A3B8;
      --accent:#EF4444;
      --text:#96dfdf;
      --card:#0b1220;
      --radius:12px;
    }
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .container{display:flex;height:100%}
    /* Left column: controls / dashboard */
    .left {
      width:420px;
      min-width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-right:1px solid #0b1726;
      display:flex;
      flex-direction:column;
      padding:20px;
      gap:12px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;margin-bottom:6px;
    }
    .logo{
      width:52px;height:52px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;font-size:24px;
      border:2px solid rgba(255,255,255,0.04)
    }
    h1{font-size:18px;margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .box{background:var(--panel);border-radius:var(--radius);padding:12px;border:1px solid rgba(255,255,255,0.02)}
    .login-row{display:flex;gap:8px;align-items:center}
    input[type="email"]{
      flex:1;padding:10px 12px;border-radius:8px;border:1px solid #283348;background:#0b1522;color:var(--text);
      outline:none;font-size:14px
    }
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:white;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    .small{font-size:13px;color:var(--muted)}
    .stats{display:flex;gap:12px;margin-top:12px}
    .stat{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:10px}
    .stat .value{font-size:20px;font-weight:700;color:var(--accent)}
    .alerts-list{margin-top:12px;overflow:auto;flex:1;padding-right:6px}
    .alert-card{background:#081221;padding:12px;border-radius:10px;margin-bottom:10px;border-left:4px solid #475569}
    .alert-card.unread{border-left-color:var(--accent);background:#071621}
    .alert-meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:8px}
    .alert-desc{color:var(--text);font-size:14px;line-height:1.3}
    .legend{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .legend-item{display:flex;align-items:center;gap:8px}
    .dot{width:12px;height:12px;border-radius:6px}
    .map-area{flex:1;position:relative;display:flex;flex-direction:column}
    #map{flex:1}
    .map-top{position:absolute;top:12px;left:12px;z-index:600}
    .map-controls{display:flex;gap:8px}
    .create-alert{position:absolute;bottom:18px;right:18px;z-index:700}
    .create-btn{background:var(--accent);padding:12px 14px;border-radius:999px;font-weight:700;border:none;cursor:pointer}
    footer{padding:8px 12px;color:var(--muted);font-size:12px;text-align:center}
    .hidden{display:none}
    .loader{border:3px solid rgba(255,255,255,0.04);border-top:3px solid var(--accent);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .flex{display:flex;align-items:center;gap:8px}
    .control-btn{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:13px;cursor:pointer;color:var(--text)}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#071025;color:var(--text)}
    .link{color:var(--accent);text-decoration:underline;cursor:pointer;font-size:13px}
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="left">
      <div class="brand">
        <div class="logo">GC</div>
        <div>
          <h1>Guardian Connect</h1>
          <div class="subtitle">Emergency Response Network</div>
        </div>
      </div>

      <div class="box">
        <div class="topbar">
          <div style="font-weight:700">Sign in</div>
          <div class="small">No password â€” use your registered email</div>
        </div>

        <div style="margin-top:12px" id="loginPanel">
          <div class="login-row">
            <input id="email" type="email" placeholder="your.facility@guardianconnect.emergency" />
            <button id="loginBtn">Sign in</button>
          </div>
          <div style="margin-top:8px" class="small">After signing in you will see alerts and the map for your facility.</div>
        </div>

        <div id="signedPanel" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="facilityName" style="font-weight:700"></div>
              <div id="facilityType" class="small"></div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end">
              <button id="signOut" class="ghost control-btn">Sign out</button>
              <div style="height:8px"></div>
              <div id="unreadBadge" style="display:none;background:var(--accent);padding:6px 8px;border-radius:999px;color:#fff;font-weight:700"></div>
            </div>
          </div>

          <div class="stats" style="margin-top:12px">
            <div class="stat">
              <div class="value" id="totalAlerts">0</div>
              <div class="small">Total Alerts</div>
            </div>
            <div class="stat">
              <div class="value" id="unreadAlerts">0</div>
              <div class="small">Unread</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="refreshBtn" class="control-btn">Refresh</button>
            <div class="search" style="flex:1">
              <input id="filterInput" placeholder="Filter by description..." />
            </div>
            <button id="toggleAlerts" class="control-btn">Hide Alerts</button>
          </div>

          <div class="alerts-list box" id="alertsList" style="margin-top:12px;max-height:380px"></div>
        </div>
      </div>

      <div style="margin-top:12px" class="box">
        <div style="font-weight:700;margin-bottom:8px">Legend</div>
        <div class="legend">
          <div class="legend-item"><div class="dot" style="background:#10B981"></div><div class="small">Hospitals</div></div>
          <div class="legend-item"><div class="dot" style="background:#3B82F6"></div><div class="small">Police Stations</div></div>
          <div class="legend-item"><div class="dot" style="background:#EF4444"></div><div class="small">Fire Stations / Alerts</div></div>
        </div>
      </div>

      <footer>
        Guardian Connect â€” Web UI Â· Uses Supabase & your server API
      </footer>
    </div>

    <div class="map-area">
      <div class="map-top">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="zoomHome" class="control-btn">Center on facility</button>
          <button id="locateBtn" class="control-btn">Use my location</button>
          <button id="newAlert" class="control-btn">Create alert at my location</button>
        </div>
      </div>

      <div id="map"></div>

      <div class="create-alert">
        <button id="quickAlert" class="create-btn">+ Quick Alert</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

  <script>
    /*********************** CONFIG â€” EDIT THESE ************************/
    // Replace these with your Supabase details (anon key is for client usage)
    const SUPABASE_URL = 'https://tciyznpyhpacpkxppiqk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjaXl6bnB5aHBhY3BreHBwaXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Mjc1NTcsImV4cCI6MjA3ODEwMzU1N30.lwPqJ9LtrQtoF646ERKh_hdIPO2gC7-27AcXZQe7QaA';

    // If you want the web UI to POST alerts to your server (recommended),
    // set API_BASE to the origin or absolute URL where server.js runs.
    // e.g. const API_BASE = 'http://localhost:3000';
    const API_BASE = window.location.origin; // assumes server and web are same origin
    /********************************************************************/

    if (SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
      alert('Please edit index.html and set SUPABASE_URL and SUPABASE_ANON_KEY before using the app.');
    }

    // FIX: Use the correct global variable name for Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI elements
    const emailEl = document.getElementById('email');
    const loginBtn = document.getElementById('loginBtn');
    const loginPanel = document.getElementById('loginPanel');
    const signedPanel = document.getElementById('signedPanel');
    const facilityNameEl = document.getElementById('facilityName');
    const facilityTypeEl = document.getElementById('facilityType');
    const signOutBtn = document.getElementById('signOut');
    const alertsListEl = document.getElementById('alertsList');
    const totalAlertsEl = document.getElementById('totalAlerts');
    const unreadAlertsEl = document.getElementById('unreadAlerts');
    const unreadBadgeEl = document.getElementById('unreadBadge');
    const refreshBtn = document.getElementById('refreshBtn');
    const filterInput = document.getElementById('filterInput');
    const toggleAlertsBtn = document.getElementById('toggleAlerts');
    const zoomHomeBtn = document.getElementById('zoomHome');
    const locateBtn = document.getElementById('locateBtn');
    const quickAlertBtn = document.getElementById('quickAlert');
    const newAlertBtn = document.getElementById('newAlert');

    let currentAmenity = null;
    let alerts = [];
    let amenities = [];
    let map, facilityMarker, amenityMarkers = [], alertMarkers = [];
    let showAlerts = true;

    /********************* MAP SETUP (Leaflet) *************************/
    function initMap() {
      map = L.map('map', { center: [20, 77], zoom: 5, preferCanvas: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    function addAmenitiesToMap() {
      // remove old
      amenityMarkers.forEach(m => m.remove());
      amenityMarkers = [];

      amenities.forEach(a => {
        const lat = parseFloat(a.latitude);
        const lon = parseFloat(a.longitude);
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          const color = a.type === 'hospital' ? '#10B981' : a.type === 'police' ? '#3B82F6' : '#EF4444';
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            color: '#fff',
            weight: 2,
            fillColor: color,
            fillOpacity: 1
          }).addTo(map);
          marker.bindPopup(`<b>${escapeHtml(a.name)}</b><br/>${escapeHtml(a.type)}<br/>${escapeHtml(a.email || '')}`);
          amenityMarkers.push(marker);
        }
      });
    }

    function addAlertsToMap() {
      alertMarkers.forEach(m => m.remove());
      alertMarkers = [];

      if (!showAlerts) return;

      alerts.forEach(a => {
        const lat = parseFloat(a.latitude);
        const lon = parseFloat(a.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const marker = L.marker([lat, lon], {
        }).addTo(map);
        marker.bindPopup(`<b>Accident</b><br/>${escapeHtml(a.description || '')}`);
        alertMarkers.push(marker);
      });
    }
    /********************************************************************/

    /********************* UTILITIES ***********************************/
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function setText(el, txt){ el.textContent = txt ?? ''; }
    /********************************************************************/

    /********************* AUTH / LOGIN ********************************/
    loginBtn.addEventListener('click', login);
    emailEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });

    async function login(){
      const email = (emailEl.value || '').trim().toLowerCase();
      if(!email){ alert('Enter email'); emailEl.focus(); return; }
      loginBtn.disabled = true; loginBtn.textContent = 'Signing in...';
      try {
        const { data: amenity, error } = await supabase
          .from('amenities')
          .select('*')
          .eq('email', email)
          .maybeSingle();

        if (error) throw error;

        if (!amenity) {
          alert('This email is not registered. Contact your administrator.');
          return;
        }

        currentAmenity = amenity;
        onSignedIn();
      } catch(err) {
        console.error(err);
        alert('Login failed. Check console.');
      } finally {
        loginBtn.disabled = false; loginBtn.textContent = 'Sign in';
      }
    }

    signOutBtn.addEventListener('click', ()=>{ currentAmenity=null; hide(signedPanel); show(loginPanel); map.setView([20,77],5); });

    function onSignedIn(){
      hide(loginPanel);
      show(signedPanel);
      setText(facilityNameEl, currentAmenity.name || 'Facility');
      setText(facilityTypeEl, currentAmenity.type ? (currentAmenity.type==='hospital' ? 'ðŸ¥ Hospital' : currentAmenity.type==='police' ? 'ðŸš” Police' : 'ðŸš’ Fire Station') : '');
      refreshAll();
      if (Number.isFinite(parseFloat(currentAmenity.latitude)) && Number.isFinite(parseFloat(currentAmenity.longitude))) {
        map.setView([parseFloat(currentAmenity.latitude), parseFloat(currentAmenity.longitude)], 12);
      }
    }
    /********************************************************************/

    /********************* DATA LOADING ********************************/
    async function loadAmenities(){
      try {
        // prefer server endpoint if available
        const apiRes = await fetch(API_BASE + '/api/amenities');
        if (apiRes.ok) {
          const json = await apiRes.json();
          amenities = json.amenities || [];
        } else {
          // fallback to supabase client read
          const { data } = await supabase.from('amenities').select('id,name,type,latitude,longitude,email,address').order('name');
          amenities = data || [];
        }
      } catch(err){
        console.error('loadAmenities error', err);
        // fallback to supabase
        const { data } = await supabase.from('amenities').select('id,name,type,latitude,longitude,email,address').order('name');
        amenities = data || [];
      }
      addAmenitiesToMap();
    }

    async function loadAlerts(){
      // read from supabase's alert_notifications joined with accident_alerts
      try {
        const { data, error } = await supabase
          .from('alert_notifications')
          .select(`
            id,
            distance_km,
            read,
            created_at,
            alert_id,
            accident_alerts (
              id,
              latitude,
              longitude,
              description,
              created_at,
              resolved
            )
          `)
          .eq('amenity_id', currentAmenity.id)
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        const formatted = (data || []).map(n => ({
          id: n.id,
          distance: n.distance_km,
          read: n.read,
          timestamp: n.accident_alerts?.created_at,
          description: n.accident_alerts?.description,
          latitude: n.accident_alerts?.latitude,
          longitude: n.accident_alerts?.longitude,
          resolved: n.accident_alerts?.resolved
        }));
        alerts = formatted;
      } catch(err){
        console.error('loadAlerts error', err);
        alerts = [];
      }

      renderAlerts();
      addAlertsToMap();
    }
    /********************************************************************/

    /********************* RENDERING ***********************************/
    function renderAlerts(){
      alertsListEl.innerHTML = '';
      const filter = (filterInput.value || '').trim().toLowerCase();

      const shown = alerts.filter(a => {
        if(!showAlerts) return false;
        if(!filter) return true;
        return (a.description || '').toLowerCase().includes(filter);
      });

      if (shown.length === 0){
        const el = document.createElement('div'); el.className='small'; el.textContent = alerts.length ? 'No matching alerts' : 'No alerts yet'; alertsListEl.appendChild(el); return;
      }

      shown.forEach(a => {
        const card = document.createElement('div');
        card.className = 'alert-card' + (a.read ? '' : ' unread');
        const meta = document.createElement('div'); meta.className='alert-meta';
        const dist = document.createElement('div'); dist.textContent = a.distance ? (Number(a.distance).toFixed(1) + ' km') : '';
        const time = document.createElement('div'); time.className='small'; time.textContent = prettyTime(a.timestamp);
        meta.appendChild(dist); meta.appendChild(time);
        const desc = document.createElement('div'); desc.className='alert-desc'; desc.textContent = a.description || 'No description';
        card.appendChild(meta); card.appendChild(desc);
        card.addEventListener('click', ()=> markAsRead(a.id));
        alertsListEl.appendChild(card);
      });

      setText(totalAlertsEl, String(alerts.length));
      const unreadCount = alerts.filter(x => !x.read).length;
      setText(unreadAlertsEl, String(unreadCount));
      if(unreadCount>0){ unreadBadgeEl.style.display='inline-block'; unreadBadgeEl.textContent=unreadCount; } else unreadBadgeEl.style.display='none';
    }
    /********************************************************************/

    /********************* ACTIONS *************************************/
    async function markAsRead(notificationId){
      try {
        await supabase.from('alert_notifications').update({ read:true }).eq('id', notificationId);
        // optimistic UI
        alerts = alerts.map(a => a.id === notificationId ? { ...a, read:true } : a);
        renderAlerts();
      } catch(err){ console.error(err); }
    }

    async function createAlertAtCurrentLocation() {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
      quickAlertBtn.disabled = true; quickAlertBtn.textContent='Sending...';
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        const description = prompt('Describe the incident (required):');
        if(!description){ quickAlertBtn.disabled=false; quickAlertBtn.textContent='+ Quick Alert'; return; }

        try {
          const res = await fetch(API_BASE + '/api/accident-alert', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lat, lon, description })
          });
          const j = await res.json();
          if (!res.ok) { alert('Failed creating alert: ' + (j.error || JSON.stringify(j))); }
          else { alert(j.message || 'Alert created'); refreshAll(); }
        } catch(err){ console.error(err); alert('Failed to create alert'); }
        quickAlertBtn.disabled=false; quickAlertBtn.textContent='+ Quick Alert';
      }, err => {
        alert('Location error: ' + err.message); quickAlertBtn.disabled=false; quickAlertBtn.textContent='+ Quick Alert';
      }, { enableHighAccuracy:true, timeout:10000 });
    }

    async function gotoMyLocation(){
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        map.setView([pos.coords.latitude, pos.coords.longitude], 13);
      }, err => alert('Location error: ' + err.message), { enableHighAccuracy:true, timeout:10000 });
    }

    async function refreshAll(){
      await loadAmenities();
      if (currentAmenity) await loadAlerts();
    }

    refreshBtn.addEventListener('click', refreshAll);
    filterInput.addEventListener('input', renderAlerts);
    toggleAlertsBtn.addEventListener('click', ()=>{ showAlerts = !showAlerts; toggleAlertsBtn.textContent = showAlerts ? 'Hide Alerts' : 'Show Alerts'; renderAlerts(); addAlertsToMap(); });
    zoomHomeBtn.addEventListener('click', ()=>{ if(currentAmenity && Number.isFinite(parseFloat(currentAmenity.latitude))) map.setView([parseFloat(currentAmenity.latitude), parseFloat(currentAmenity.longitude)], 12); });
    locateBtn.addEventListener('click', gotoMyLocation);
    quickAlertBtn.addEventListener('click', createAlertAtCurrentLocation);
    newAlertBtn.addEventListener('click', createAlertAtCurrentLocation);

    function prettyTime(ts){
      if(!ts) return '';
      const d = new Date(ts);
      const diff = Date.now() - d.getTime();
      const mins = Math.floor(diff/60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm';
      const hrs = Math.floor(mins/60);
      if (hrs < 24) return hrs + 'h';
      const days = Math.floor(hrs/24);
      return days + 'd';
    }

    /********************* INIT ***************************************/
    (function init(){
      initMap();
      // try to center map on user's IP location via free service (non-blocking)
      fetch('https://ipapi.co/json/').then(r=>r.json()).then(j=>{
        if(j && j.latitude && j.longitude) map.setView([j.latitude,j.longitude],7);
      }).catch(()=>{});
      // start periodic refresh of alerts (if signed in)
      setInterval(()=>{ if(currentAmenity) loadAlerts(); }, 15000);
    })();
    /********************************************************************/
  </script>
</body>
</html>